import sys
import numpy as np

if sys.version_info[0] < 3:
    raise Exception("Must be using Python 3")

from absl import logging as absl_logging
absl_logging.set_verbosity('error')
from jax.config import config as jax_config
jax_config.update("jax_platform_name", "cpu")
jax_config.update("jax_enable_x64", True)
import jax.numpy as ag_np


def _polyval_old(x, c):
    """Analagous to np.polyval (which is not differentiable with jax)"""
    c = np.flip(c)
    ans = 0
    power = len(c) - 1
    for coef in c:
        ans = ans + coef * ag_np.power(x, power)
        power = power - 1
    return ans


def _polyval(x, c, tensor=True):
    """Analagous to np.polynomial.polynomial.polyval (which is not
    differentiable with jax)"""

    c = ag_np.array(c, ndmin=1, copy=False)
    if c.dtype.char in '?bBhHiIlLqQpP':
        # astype fails with NA
        c = c + 0.0
    if isinstance(x, (tuple, list)):
        x = ag_np.asarray(x)
    if isinstance(x, ag_np.ndarray) and tensor:
        c = c.reshape(c.shape + (1,) * x.ndim)

    c0 = c[-1] + x * 0
    for i in range(2, len(c) + 1):
        c0 = c[-i] + c0 * x
    return c0


def _polygrid2d(c, *args):
    """Analagous to np.polynomial.polynomial.polygrid2d (which is not
    differentiable with jax)"""

    for xi in args:
        c = _polyval(xi, c)
    return c


def _approx_ln_f(epsilon_over_dis, alpha, inferring_alpha=False):
    """TODO"""
    if alpha == -3 and not inferring_alpha:
        ln_f_mean = _polyval(epsilon_over_dis, c=coefs_mean_alpha_minus3)
        ln_f_var = _polyval(epsilon_over_dis, c=coefs_var_alpha_minus3)
    else:
        ln_f_mean = _polygrid2d(epsilon_over_dis, coefs_mean)
        ln_f_var = _polygrid2d(epsilon_over_dis, coefs_var)
    return ln_f_mean, ln_f_var


# COEFS AT MIN_DIS=0.5
coefs_mean_alpha_minus3 = np.array([
    -0.028093639636097123, 1.1719218436242866, -0.32729806977188536,
    -4.685909281043588, 6.155938632438331, -3.9334072954891717,
    1.5713138125394583, -0.4318193807783164, 0.08594056571967137,
    -0.012785073537971115, 0.0014510428742666398, -0.0001272534419016317,
    8.681630478552977e-06, -4.61375227636075e-07, 1.9018596428284558e-08,
    -6.015221660782645e-10, 1.4311188449340554e-11, -2.476733232328295e-13,
    2.9417092821278008e-15, -2.1435189438270842e-17, 7.222621297713678e-20])
coefs_var_alpha_minus3 = np.array([
    -5.021597182678841, 36.06555533545901, -79.67621276833034,
    91.65570996949957, -65.25095014247461, 31.056127374847637,
    -10.396078175527533, 2.5380564896792945, -0.46402725599788086,
    0.0647656216346739, -0.006994391047513398, 0.0005894922958888848,
    -3.893079982682449e-05, 2.0136914201551016e-06, -8.113042129252535e-08,
    2.516252660796367e-09, -5.885998889253996e-11, 1.0036794797646503e-12,
    -1.1766620047887206e-14, 8.475242868614452e-17, -2.826363458904606e-19])


# # ORIGINAL COEFS
# coefs_mean_alpha_minus3 = np.flip(np.array([5.549172757571418e-20, -1.6470775119344408e-17, 2.2606861003877433e-15, -1.903579023849604e-13, 1.1000461737635397e-11, -4.6239683202570464e-10, 1.4619806820341588e-08, -3.546250613583712e-07, 6.670958632097694e-06, -9.772260096077662e-05, 0.0011130662843361946, -0.00978764088393751, 0.0655592914191458, -0.3273049894339556, 1.1766273423250435, -2.872565184957617, 4.228635441434826, -2.533538222083517, -1.3991509787571033, 0.5364137375876942, -0.014652303861952376]))
# coefs_var_alpha_minus3 = np.flip(np.array([-8.89723012160453e-20, 2.6939031920163006e-17, -3.780088866833452e-15, 3.262503889748274e-13, -1.9384315351972383e-11, 8.408736957761065e-10, -2.7561824714335875e-08, 6.969965186508444e-07, -1.3766418318829012e-05, 0.00021367122264464005, -0.002609568682021054, 0.025003741308379887, -0.18663053580505512, 1.0728333419317682, -4.671837208672972, 15.062582659039125, -34.8224086368473, 55.041717936059165, -54.63542672952499, 25.766016969084514, -5.116935512532633]))

# # COEFS AT MIN_DIS=0.1
# coefs_mean_alpha_minus3 = np.flip(np.array([
#     2.384889410013454e-19, -7.09217682750386e-17, 9.755240989455971e-15,
#     -8.234401900887648e-13, 4.7719863208577084e-11, -2.0125096869143915e-09,
#     6.388048073690807e-08, -1.5568760852967947e-06, 2.9458521037985152e-05,
#     -0.0004347345012400323, 0.004999412137360226, -0.044533630001969714,
#     0.30376137311210993, -1.5579987775539812, 5.847781756295625,
#     -15.41602380542562, 26.715281957543787, -26.878052622307614,
#     11.237646192159167, 0.28700351181475076, -0.04853527586834172]))
# coefs_var_alpha_minus3 = np.flip(np.array([
#     -1.9596564513197989e-19, 5.990494920245483e-17, -8.492150322595947e-15,
#     7.409704524507516e-13, -4.454025803350512e-11, 1.9562311158004665e-09,
#     -6.497268272995859e-08, 1.6662341236703887e-06, -3.3399983506444664e-05,
#     0.0005264930711673488, -0.006533769910014356, 0.06362682098466368,
#     -0.48252249055772517, 2.814769837837176, -12.40609749234265,
#     40.289842664921046, -93.0841178589773, 145.44163455099812,
#     -141.97518586894176, 73.75640022693754, -8.58479540528811]))

coefs_mean = np.array([
    -65609.59699465334, -463193.7007776554, -1458392.210865665,
    -2664301.9224915295, -3026450.548148401, -1997732.2276929354,
    -317800.57886791375, 831823.2528953279, 1033804.9695300476,
    691091.6189666676, 314142.8778799255, 102807.2150980545, 24661.49991096942,
    4438.282889002413, 667.9516690025474, 110.0125777873759, 21.416088179102868,
    3.6190948812418755, 0.41662226476676834, 0.02803184866318905,
    0.0008330933970558703, 18421.857296204493, 135296.81125414048,
    453982.4412607653, 921544.2610745372, 1261627.6269220628,
    1227091.8226130807, 866701.8000823722, 442430.85843690665,
    155053.15577033427, 29546.82003882661, -2962.3136663995765,
    -4514.233039312917, -1813.8255153689527, -456.13802020314165,
    -79.5064059113447, -9.6284415883542, -0.7630457180532502,
    -0.032828847824859585, -0.00020364115453158898, 2.9633723993460014e-05, 0,
    -1342.7352229585915, -9738.09253236462, -32037.36975785849,
    -63507.427397829095, -84533.87681018874, -79512.01325119511,
    -54119.10275103667, -26837.424596137855, -9640.245300733166,
    -2485.886002533154, -481.9457955134383, -96.78834465724627,
    -29.805366821685553, -9.481941520385696, -2.164055966035166,
    -0.32340631976722783, -0.029961791321438, -0.001535502922372034,
    -3.191509684382424e-05, 0, 0, 24.640487022812376, 255.27054283793586,
    886.9933802432273, 1816.316142691633, 2577.0354146206414,
    2631.9353763676168, 1924.584732873711, 984.7604317238997, 332.1797204195491,
    58.38315006316655, -5.023985803460848, -6.4301560276422425,
    -1.989028603690523, -0.3422630840369645, -0.03249278605348338,
    -0.000985598825778635, 9.720973742484766e-05, 7.531527241510296e-06, 0, 0,
    0, 8.407358098000712, 6.181661693063021, -2.9563828010309985,
    15.848495356238953, 46.215271901768965, 43.14613381304559,
    18.247793743678745, 2.7216993578471955, -0.12063781144376937,
    0.38504893249829714, 0.4116004822691694, 0.1787455683897987,
    0.048013261217512704, 0.008961232622575529, 0.001161554742069343,
    9.377483390304639e-05, 3.4882724653195763e-06, 0, 0, 0, 0,
    -3.7721025792486844, -3.7145419841411043, 3.0611706656183326,
    7.2524590950832755, 2.7376018729788014, -1.6949321496590455,
    -1.7354136416006596, -0.46698714418677434, 0.03137723146889519,
    0.041945703802198184, 0.007885585796633695, 0.0005657656491650028,
    0.00016081833553009917, 6.261346272261696e-05, 9.230565030717989e-06,
    4.733729986824859e-07, 0, 0, 0, 0, 0, 1.054780104380158, 1.38823866453667,
    0.475192697158699, -0.9067315316169806, -0.88987088553765,
    -0.2565886354615689, 0.037963378996827876, 0.0358159593410018,
    0.002540859979342647, -0.0027735675473338226, -0.0008217123547747708,
    -5.884590075303649e-05, 9.480675520357382e-06, 1.8856249589267973e-06,
    9.336321199248933e-08, 0, 0, 0, 0, 0, 0, -0.19600665553478444,
    -0.23907192624609572, -0.1935953536355508, 0.0007103161651499746,
    0.06736141196560935, 0.03610703304791959, 0.005467323067447434,
    -0.0016621916623082, -0.0007780329956440696, -7.923224779078891e-05,
    1.3877873430779474e-05, 4.3155198532500165e-06, 4.109085256660073e-07,
    1.3846074794744681e-08, 0, 0, 0, 0, 0, 0, 0, 0.027634374922740266,
    0.023205178522633978, 0.02561709937649105, 0.007931103949276715,
    -0.0012399518336212955, -0.0019547253652179345, -0.0006517568089116434,
    -6.438332456792947e-05, 1.5382005642237416e-05, 5.341629142099519e-06,
    6.288539333112039e-07, 3.018159902471028e-08, 3.1215282255665175e-10, 0, 0,
    0, 0, 0, 0, 0, 0, -0.0032275801618064023, -0.0012850371649908326,
    -0.0019734004557126947, -0.0007910536591334275, -0.0001352944465419324,
    2.9290231517064708e-05, 2.170032568319646e-05, 4.853652460958105e-06,
    4.4675110266917247e-07, -2.269504997904695e-09, -3.200900308455961e-09,
    -1.5545590973534483e-10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0003204544252147766,
    2.37354105068824e-05, 0.00010295594314184437, 4.0496616122547234e-05,
    1.0042693598450633e-05, 1.1002628772573832e-06, -1.6343459108574984e-07,
    -7.169268513011179e-08, -9.364966247638877e-09, -5.009843504736091e-10,
    -7.014957427106808e-12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -2.6585169813601105e-05, 2.5277507537809717e-06, -3.986727319871375e-06,
    -1.3270199852240728e-06, -3.1595450923354055e-07, -5.127550840644601e-08,
    -3.7072982426030102e-09, 1.7843010552642932e-10, 4.5644481345622373e-11,
    1.96435948835555e-12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    1.7937659162861122e-06, -2.8395478993928416e-07, 1.2155042693677467e-07,
    3.129598467051917e-08, 5.788009873929625e-09, 8.743517442648236e-10,
    8.04102356549234e-11, 3.063214415329937e-12, -8.662837439702464e-15, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -9.636297433964657e-08,
    1.6092169251985403e-08, -2.9609563352371597e-09, -5.754533231070322e-10,
    -6.875776711716262e-11, -7.577317565198557e-12, -5.536318415979846e-13,
    -1.6425895010817438e-14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    4.054369998032247e-09, -6.136016352818644e-10, 5.5924189915615274e-11,
    8.409219376003827e-12, 5.695993328666089e-13, 3.351309982461323e-14,
    1.2553206216483988e-15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -1.3135077912978568e-10, 1.6557648617550228e-11, -7.709149357748344e-13,
    -9.128217082602735e-14, -3.312976392543061e-15, -6.51277834359795e-17, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3.202806899523252e-12,
    -3.138180857365515e-13, 7.112348427521873e-15, 6.327764639100923e-16,
    1.0397046303466521e-17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -5.6754714744450764e-14, 3.989727038915679e-15, -3.809664809130702e-17,
    -2.0474015545406528e-18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    6.89096730633969e-16, -3.0621192007220403e-17, 8.517113153287089e-20, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -5.12311140148579e-18,
    1.0739884301277239e-19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 1.7578127764561396e-20, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0]).reshape(21, 21)
coefs_var = np.array([
    -421692.4075222745, -3668794.9592412733, -14606723.299135275,
    -35243283.79768066, -57469111.88100234, -66748899.98073972,
    -56516625.958063476, -34863031.54913922, -15129634.908164619,
    -4050718.5751852524, -233132.78819806848, 314535.25319326366,
    140652.7987526114, 22788.20048270796, -3210.0735384443983,
    -2685.4359385363105, -723.5159248987894, -114.81850949153781,
    -11.35563460102889, -0.6530069807775714, -0.016801763993224268,
    -55247.37354715899, -387900.174663694, -1218528.0056960022,
    -2251084.515838771, -2690533.758455524, -2136765.0711452225,
    -1086923.2346728083, -288509.0625431941, 14915.208394006173,
    33311.97697128739, -551.3357855506713, -10551.609812818566,
    -6229.832931414797, -1968.8005566736897, -378.853178288834,
    -40.906585008343676, -1.058293251821541, 0.31592143470569983,
    0.04004943864414396, 0.0015762603120590252, 0, 6907.644097338889,
    52703.75595800674, 178988.23523203327, 360195.27953035553,
    475899.0821623305, 428979.39934381, 260790.35511220462, 95197.94455855594,
    6761.374374765652, -14886.210630871576, -10155.359516389635,
    -3659.864322026455, -816.4418133647214, -100.94846708357962,
    -0.7613722583199689, 2.0767066933150655, 0.3669962939895001,
    0.029236678874376722, 0.0009510627774154581, 0, 0, -179.94496395339226,
    -2258.119678737943, -9023.049923497088, -20973.00162499922,
    -32355.339376861142, -35380.01910261812, -28411.524630148568,
    -17071.46363988422, -7708.1200354542025, -2577.724122468761,
    -606.3229428835433, -83.86395447030682, 0.3330387077771004,
    3.1329632039731545, 0.7563920939983871, 0.09527340066527495,
    0.006588152181899766, 0.0001982543794281475, 0, 0, 0, -43.16654328319379,
    12.023811064101034, 131.9291421587623, 323.33843576757585,
    465.50003195595446, 476.35157504988837, 360.90608375081354,
    209.93911107804843, 98.8934397889692, 39.724918710633354,
    13.751090220252383, 3.929214898269972, 0.8670304303277948,
    0.1381515668969829, 0.014747025178192886, 0.0009368580814960604,
    2.6668961421013954e-05, 0, 0, 0, 0, 17.984381491874153, 2.0556633860402664,
    -15.859648112007715, -38.524154162270236, -43.45799766085778,
    -34.545353075543325, -19.994242847602614, -7.718379522662476,
    -1.4779110626498537, 0.20874114732154414, 0.23271749344773068,
    0.07482280875917748, 0.013579853352849856, 0.001471828832016709,
    8.847907497832881e-05, 2.250532921349125e-06, 0, 0, 0, 0, 0,
    -5.3646066916444015, -1.7695912374993186, -0.4857503612616987,
    2.2170242910322733, 2.4582034635105745, 1.746142825024804,
    1.0627523460500685, 0.5463300374769718, 0.21341812249606612,
    0.05897304548245194, 0.01099917074887805, 0.001302804713153469,
    8.605795746825978e-05, 2.0400992483318078e-06, -3.891019344171909e-08, 0, 0,
    0, 0, 0, 0, 1.1394159872333858, 0.3146268989406085, 0.31400700856427477,
    -0.03755123575585579, -0.08798403925661842, -0.03659497613017456,
    -0.006454017459270771, -0.0010163476327973858, -0.0007870965959392877,
    -0.00039416097792180675, -0.00010103689042759247, -1.4361324218717251e-05,
    -1.0896038555670481e-06, -3.45954672047151e-08, 0, 0, 0, 0, 0, 0, 0,
    -0.18388156764288177, -0.02808806325525403, -0.04552669786871486,
    -0.0062585146417102125, 0.0035485427548997634, 0.0022152217668813348,
    0.0004317160381833838, -2.8005824976875103e-05, -3.0355561362085807e-05,
    -6.293748343248315e-06, -6.107980318698716e-07, -2.527229197741782e-08,
    -1.521657325978907e-10, 0, 0, 0, 0, 0, 0, 0, 0, 0.023312759289851822,
    0.0008894626195071308, 0.00413410013580131, 0.0008979930433023,
    6.842404576476096e-06, -7.348812699600792e-05, -2.4642522561853414e-05,
    -3.661866941020995e-06, -1.6254934234158182e-07, 2.543476179948773e-08,
    3.758627173956147e-09, 1.4816638154491757e-10, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -0.0023537382923768404, 0.00010087186486784056, -0.0002634891338209259,
    -5.868988971866487e-05, -7.629899624897058e-06, 5.179044585320043e-07,
    4.2180387617390604e-07, 7.863788903004969e-08, 7.108672030234636e-09,
    2.829393866599845e-10, 2.0867594943156976e-12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0.00018985277299515818, -1.6842644806439273e-05, 1.2542662056730323e-05,
    2.414498678730667e-06, 3.598752910069291e-07, 2.4232979483819637e-08,
    -2.094921264613832e-09, -5.911034573062495e-10, -4.797400446999289e-11,
    -1.3822783955002313e-12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -1.2205064785570826e-05, 1.3170078661375778e-06, -4.6082938093888166e-07,
    -6.966636990908658e-08, -9.208715698285238e-09, -7.564045821359016e-10,
    -2.2398055645122667e-11, 1.298215523374808e-12, 9.31546860604913e-14, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6.217171204122029e-07, -6.827466641020973e-08,
    1.3154888601471796e-08, 1.4636190257939599e-09, 1.5146439102792665e-10,
    1.0330299737464445e-11, 3.4804159571155907e-13, 2.8057644284188964e-15, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -2.48597300001093e-08,
    2.522938908302207e-09, -2.8760093320564435e-10, -2.226621009090542e-11,
    -1.624699649405429e-12, -7.488684379098249e-14, -1.407961268290662e-15, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7.691138791653859e-10,
    -6.730567897135218e-11, 4.65486965386279e-12, 2.344499122440245e-13,
    1.0484962351440838e-14, 2.374129182886478e-16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, -1.800627269998293e-11, 1.2731904714760547e-12,
    -5.248921252140231e-14, -1.5357351162722162e-15, -3.1086332896889817e-17, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3.0796269696905517e-13,
    -1.6249377881780432e-14, 3.6751461518123846e-16, 4.727249619148892e-18, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -3.6261385165991004e-15,
    1.2570013385352974e-16, -1.2010449488571955e-18, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 2.6253947460624614e-17, -4.456418428529003e-19,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -8.804915238295187e-20, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0]).reshape(21, 21)
