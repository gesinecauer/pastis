import sys
import numpy as np

if sys.version_info[0] < 3:
    raise Exception("Must be using Python 3")

use_jax = True
if use_jax:
    from absl import logging as absl_logging
    absl_logging.set_verbosity('error')
    from jax.config import config as jax_config
    jax_config.update("jax_platform_name", "cpu")
    jax_config.update("jax_enable_x64", True)

    import jax.numpy as ag_np
else:
    import autograd.numpy as ag_np


def _polyval(x, c, tensor=True):
    """Analagous to np.polynomial.polynomial.polyval (which is not
    differentiable with jax)"""

    c = np.array(c, ndmin=1, copy=False)
    if c.dtype.char in '?bBhHiIlLqQpP':
        # astype fails with NA
        c = c + 0.0
    if isinstance(x, (tuple, list)):
        x = ag_np.asarray(x)
    if isinstance(x, np.ndarray) and tensor:
        c = c.reshape(c.shape + (1,) * x.ndim)

    c0 = c[-1] + x * 0
    for i in range(2, len(c) + 1):
        c0 = c[-i] + c0 * x
    return c0


def _polygrid2d(c, *args):
    """Analagous to np.polynomial.polynomial.polygrid2d (which is not
    differentiable with jax)"""

    for xi in args:
        c = _polyval(xi, c)
    return c


coefs_mean = np.array([
    29030.549383605874, -2007.5224680172837, -84.68113045127278,
    12.079348821452623, -1.762458822047655, 0.2760226579708814,
    -0.027313785221462106, -0.000778651914271259, 0.000957389013031846,
    -0.0002144789077028607, 3.0183637476948862e-05, -3.05283196166787e-06,
    2.313650853102834e-07, -1.3346034655707415e-08, 5.877632380797232e-10,
    -1.96337880709302e-11, 4.890671801511016e-13, -8.80141395231243e-15,
    1.0811535335099739e-16, -8.111566850113033e-19, 2.8039781417174482e-21,
    244896.18207711916, -16976.883127459885, -423.53337632718683,
    41.118896674978885, -4.223649277265691, 0.7306118510713216,
    -0.09611362192230082, 0.011264553338874215, -0.0012745973812688185,
    0.0001417375897594681, -1.3808442938410958e-05, 1.0727633307709716e-06,
    -6.431459981468081e-08, 2.944489557941575e-09, -1.0192102895095907e-10,
    2.6205308648594944e-12, -4.84967974336162e-14, 6.105933954623634e-16,
    -4.6821826075387386e-18, 1.6503255658729156e-20, 0, 960501.6401053835,
    -65476.0704093077, -927.3741061626151, 37.96884639266046,
    0.07836023266853481, 0.811290375214282, -0.12133175033189356,
    0.011610905326614369, -0.0007143174420551822, 2.8077836446804156e-05,
    -6.970619453661017e-07, 5.095429391997394e-09, 5.151929338569341e-10,
    -3.036288218515307e-11, 9.279664809750044e-13, -1.8030171141534717e-14,
    2.242770185616258e-16, -1.6449103608334114e-18, 5.4535078110781455e-21, 0,
    0, 2328117.1390385386, -153123.97176655542, -1139.6923511758048,
    -59.24100003713159, 18.87506054290452, -0.204183094801432,
    -0.06003957817016917, 0.008156778902624336, -0.0005680141722785681,
    2.291079717386342e-05, -6.487038840808836e-07, 1.503351476649196e-08,
    -2.838509677437707e-10, 3.662904604826798e-12, -2.0334834510309504e-14,
    -1.6471964196308449e-16, 3.3442835577610807e-18, -1.590956391341495e-20, 0,
    0, 0, 3909346.256135504, -243094.38170605162, -846.7840033790237,
    -191.55166374433287, 40.986419611539745, -1.433327320519612,
    0.01996128371293715, 0.0022756985042435636, -0.00025858281433623217,
    1.0503076023809573e-05, -2.470513605468834e-07, 4.50251752301637e-09,
    -7.589255680835138e-11, 1.062425095978657e-12, -9.860726219570664e-15,
    4.8853778304693096e-17, -8.677930361018332e-20, 0, 0, 0, 0,
    4830245.192433896, -277393.9681203594, -374.5393589653346,
    -236.78390816570982, 48.60847953110667, -1.864334593438829,
    0.04759175972832699, -0.0008278011118784156, -6.33599894717792e-05,
    3.3399656516460915e-06, -6.736375552913664e-08, 8.082028246254708e-10,
    -8.48883305633847e-12, 9.227534911846915e-14, -6.950292162868653e-16,
    2.197256338709655e-18, 0, 0, 0, 0, 0, 4550104.448212253,
    -234392.26822746996, -106.32798934696979, -171.92134596191636,
    38.185516634795775, -1.4763801031235355, 0.03260709383902761,
    -0.0010765144502152461, 3.9345168180688346e-07, 7.107872377116175e-07,
    -1.4442016659872208e-08, 1.207747855165522e-10, -5.216167748442288e-13,
    2.4961266335274878e-15, -1.2591854219578366e-17, 0, 0, 0, 0, 0, 0,
    3338031.186087754, -148305.63921654978, -82.01134768484307,
    -78.87526875515813, 20.996891325033918, -0.8416191418612082,
    0.012890776798864889, -0.0004907090703275194, 6.200447788979756e-06,
    7.97135627043752e-08, -2.204836533562881e-09, 1.5473744069844264e-11,
    -3.0583135263057506e-14, -1.647308729252432e-17, 0, 0, 0, 0, 0, 0, 0,
    1928373.1559191756, -69718.50062473484, -136.90277597611467,
    -23.20855081370851, 8.080772543474264, -0.36612483968559734,
    0.003307852467901656, -0.0001268100679119918, 2.257153442517192e-06,
    -1.3577438524115015e-09, -2.0154278009499723e-10, 1.2571842334559658e-12,
    -1.6134478931008089e-15, 0, 0, 0, 0, 0, 0, 0, 0, 878693.1478020786,
    -23400.795534418296, -152.20940259600118, -5.546042743128863,
    2.0414105710604495, -0.12319163777987167, 0.0005954853814670607,
    -1.905280303066023e-05, 4.1808432375279387e-07, -1.636485221553848e-09,
    -8.386121963146377e-12, 4.205661421271107e-14, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    312491.7651615194, -4890.64381802013, -115.46371996122753,
    -2.577284398319944, 0.24907169734728515, -0.03164893589325628,
    8.829504547578383e-05, -1.381775082830472e-06, 4.343558671989321e-08,
    -1.8776266962329692e-10, -4.7058847647418836e-14, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 83887.67379282558, -198.6898418718671, -63.574066770442315,
    -1.6255043437200398, -0.03236334050635534, -0.0060274858296213455,
    1.3173611031510097e-05, 1.2070042162615273e-08, 2.333221481842717e-09,
    -7.206251969925009e-12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15404.19762515863,
    266.02681562660365, -25.953188985074885, -0.7106710226503304,
    -0.02172355850798222, -0.0008141771844940531, 1.780261478059085e-06,
    8.809948561393343e-09, 4.728028558308469e-11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 1165.6760607729939, 105.16040252808556, -7.8524233783696795,
    -0.2012453339593299, -0.004780175185430835, -7.289527649022302e-05,
    1.5593246250002777e-07, 4.1335074665965056e-10, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, -342.9080170223936, 21.07883441085269, -1.7356738778036145,
    -0.03719911289177529, -0.0005857268530457955, -3.830568094881933e-06,
    5.992033004807201e-09, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -156.45797412518266, 2.331137432346683, -0.2720632579754256,
    -0.004373948959057504, -3.9711550278389566e-05, -8.796161818369169e-08, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -33.60806552368152,
    0.07951410510853468, -0.028625077736766296, -0.00029864396205987525,
    -1.1673736043333693e-06, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -4.627272771056988, -0.013570649389593587, -0.0018122968321692538,
    -9.048340508083896e-06, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -0.41619132859236624, -0.001846968048247197, -5.217323868568667e-05, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.022490190368548435,
    -7.327819990689467e-05, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, -0.0005573477829322709, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0]).reshape(21, 21)


coefs_var = np.array([
    -209001.83889122386, 25284.019717879313, 2869.1947051358597,
    -301.7070741759052, -28.846624329445866, 13.03936220109978,
    -2.9999155765389474, 0.5897655834084634, -0.09509439368444958,
    0.012123698703536554, -0.0012143727038466923, 9.576574521490677e-05,
    -5.955405832110686e-06, 2.9156766752079177e-07, -1.1168177067391549e-08,
    3.305930223298261e-10, -7.406272641346872e-12, 1.2132613542338725e-13,
    -1.3702305783551046e-15, 9.531487868699834e-18, -3.076687806478278e-20,
    -1847671.0466327467, 228040.00295842226, 20194.04331810537,
    -2684.7687947270883, 33.50690193076115, 18.511924008971626,
    -1.8654136366979384, 0.08945263591081558, -0.0005978886964049274,
    -0.00034055783803104214, 3.9229373307874345e-05, -2.7808280001590512e-06,
    1.450724205185725e-07, -5.783478270105183e-09, 1.7650505648024711e-10,
    -4.058856202138719e-12, 6.807979001883374e-14, -7.859102986306035e-16,
    5.580253325865756e-18, -1.836350183902009e-20, 0, -7597690.1582263755,
    942521.9187273934, 62855.30874298053, -9235.95542070696, 314.63281991797174,
    32.77859491819024, -3.973077075207856, 0.22854578409234408,
    -0.00926721508755143, 0.000285154104038143, -6.377820329933034e-06,
    8.38174551195334e-08, 2.9617041196713304e-10, -4.644835769445469e-11,
    1.2421357661025167e-12, -1.8992054877422658e-14, 1.7575782140588707e-16,
    -8.839538851789585e-19, 1.6812329628593656e-21, 0, 0, -19306473.53283448,
    2370920.5497379303, 116515.49841072451, -18410.223412829466,
    898.4546150086858, 25.51277858268035, -4.467384959197255,
    0.24706263786123733, -0.009158078063366529, 0.0002597012746870212,
    -5.643923021268895e-06, 8.848972653795592e-08, -8.228465736960308e-10,
    -8.071655121282355e-13, 1.6480758403045868e-13, -2.675488792053998e-15,
    2.1103963059555993e-17, -7.080418778845607e-20, 0, 0, 0, -33965483.04186157,
    4068743.505259829, 144855.81057889658, -23872.069640235375,
    1428.9465916747165, 0.5601643487963159, -3.2151064575508213,
    0.17557651852892367, -0.005851251035751655, 0.0001470259485547241,
    -2.864639209682659e-06, 4.212649796523978e-08, -4.445661751360261e-10,
    3.0203974011332932e-12, -8.705090200645325e-15, -3.5769187646704023e-17,
    2.8784592507822422e-19, 0, 0, 0, 0, -43907657.48259509, 5059069.471450288,
    130279.41996103589, -21273.71655288208, 1486.828266200583,
    -19.266087899047402, -1.509896823926633, 0.08695353915891389,
    -0.002581435678076282, 5.5775628656778294e-05, -9.249673035540243e-07,
    1.145526020355453e-08, -1.0112290576495758e-10, 5.957917373751923e-13,
    -2.0441283893311807e-15, 2.6985551941711943e-18, 0, 0, 0, 0, 0,
    -43174677.564763956, 4722585.08401523, 91264.36229526495,
    -13277.587389185901, 1085.1969971671463, -21.851933373928443,
    -0.4262969105141341, 0.030836568829421197, -0.0008141383740084228,
    1.4733925099703194e-05, -2.0022427985751693e-07, 1.969984079712544e-09,
    -1.3013859996179057e-11, 5.164472551172641e-14, -9.515199715482011e-17, 0,
    0, 0, 0, 0, 0, -32948064.39773718, 3381743.256974434, 54608.17921338908,
    -5691.549081061357, 574.8977972600419, -13.981204871409343,
    -0.035797483708344166, 0.007859124095349026, -0.00018589760876148884,
    2.7315466109398588e-06, -2.9031332425253275e-08, 2.1229157873949553e-10,
    -9.271546091901157e-13, 1.795098217943843e-15, 0, 0, 0, 0, 0, 0, 0,
    -19702927.569462813, 1880134.991434113, 30444.02305919795,
    -1499.1457150006931, 224.17164925321626, -6.054181805124371,
    0.026141946940030115, 0.0014087368442444097, -3.060270955128334e-05,
    3.5022320321017867e-07, -2.7073421517973267e-09, 1.3081111171481926e-11,
    -2.8631267192526855e-14, 0, 0, 0, 0, 0, 0, 0, 0, -9231124.708555765,
    815059.6379188024, 16032.791006222165, -100.36434698746837,
    64.20643426587752, -1.8689264229850788, 0.013702217526603402,
    0.00016627266010713795, -3.5481871265105036e-06, 2.97651618055181e-08,
    -1.4689061716795192e-10, 3.4958143768682986e-13, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -3344475.85104801, 274496.8488235114, 7477.8195043511, 103.17817726683059,
    13.227533948908105, -0.41641116513705406, 0.0035310082562997444,
    1.051152658029646e-05, -2.747178274533105e-07, 1.521580847974815e-09,
    -3.538550726974191e-12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -902320.5595078159,
    70789.41913459354, 2871.6081060212623, 52.467195303087586,
    1.8547649325414466, -0.06626109629169429, 0.0005670585200293997,
    -3.1416479971273886e-08, -1.267378112631403e-08, 3.5756166114815594e-11, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -162138.32619237184, 13514.507371473144,
    866.5690940023146, 13.901602377627915, 0.15087995881590915,
    -0.007285118106378196, 5.748393305255322e-05, -5.304533668685985e-08,
    -2.595581994921147e-10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    -10123.079388900544, 1756.4281788784492, 199.71860364544779,
    2.383258749073947, 0.00190557017832682, -0.0005178303440513088,
    3.3846286508926623e-06, -2.5883099867434655e-09, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 4431.517855603726, 112.5924693723421, 34.27358932379423,
    0.27147664302751273, -0.000964953067096562, -2.079406304740346e-05,
    8.849006472328417e-08, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    1800.90760570131, -7.8909259613609395, 4.232228926788278,
    0.019753858093344564, -9.438281732755127e-05, -3.3524334657091804e-07, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 366.09530730405436,
    -2.7880541442485547, 0.3551791635863039, 0.0008202515864286587,
    -3.0099130104264304e-06, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    47.86273374629749, -0.31464675069580555, 0.018136190133431613,
    1.435984671239829e-05, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    4.074260852447197, -0.018154009040989544, 0.00042535832884746394, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.20748890335870418,
    -0.0004482645870369122, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0.004827782299237345, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0]).reshape(21, 21)
